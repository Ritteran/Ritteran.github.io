<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Income Tax Calculator FY 2024-25 | Complete ITR Tool</title>
    <meta name="description" content="Free Indian Income Tax Calculator with LTCG Indexation Tool, Depreciation Calculator, Surcharge & Marginal Relief. Budget 2024 updated rates.">
    <style>
        /* ============================================
           DESIGN SYSTEM TOKENS
           ============================================ */
        :root {
            /* Primary Colors */
            --color-primary-900: #1a1a2e;
            --color-primary-800: #16213e;
            --color-primary-700: #1f3460;
            --color-primary-500: #4a90d9;
            --color-primary-400: #6ba3e0;
            --color-primary-300: #7eb3f0;
            --color-primary-100: #e3f2fd;

            /* Accent Colors */
            --color-accent-orange: #FA5D29;
            --color-accent-green: #4caf50;
            --color-accent-yellow: #ffc107;
            --color-accent-red: #f44336;
            --color-accent-purple: #9c27b0;

            /* Semantic Colors */
            --color-old-regime: #2196f3;
            --color-new-regime: #4caf50;
            --color-savings: #FA5D29;

            /* Neutral Colors */
            --color-neutral-100: #ffffff;
            --color-neutral-200: #f8f9fa;
            --color-neutral-300: #e8e8e8;
            --color-neutral-400: #9e9e9e;
            --color-neutral-500: #666666;
            --color-neutral-600: #444444;
            --color-neutral-700: #333333;
            --color-neutral-800: #222222;

            /* Evidence Tier Colors */
            --tier-1: #4caf50;
            --tier-2: #2196f3;
            --tier-3: #ff9800;
            --tier-4: #ff5722;
            --tier-5: #f44336;

            /* Typography - Fluid Scaling */
            --font-size-xs: clamp(0.7rem, 0.65rem + 0.25vw, 0.8rem);
            --font-size-sm: clamp(0.8rem, 0.75rem + 0.25vw, 0.9rem);
            --font-size-base: clamp(0.9rem, 0.85rem + 0.25vw, 1rem);
            --font-size-lg: clamp(1rem, 0.95rem + 0.25vw, 1.125rem);
            --font-size-xl: clamp(1.125rem, 1rem + 0.5vw, 1.375rem);
            --font-size-2xl: clamp(1.25rem, 1.1rem + 0.75vw, 1.75rem);
            --font-size-3xl: clamp(1.5rem, 1.25rem + 1.25vw, 2.25rem);

            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;

            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.2);
            --shadow-xl: 0 20px 60px rgba(0,0,0,0.25);

            /* Borders */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;

            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-base: 0.3s ease;
            --transition-slow: 0.5s ease;
            --easing-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
            --easing-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ============================================
           CSS RESET & BASE
           ============================================ */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            font-size: var(--font-size-base);
            line-height: 1.6;
            color: var(--color-neutral-700);
            background: linear-gradient(135deg, var(--color-primary-900) 0%, var(--color-primary-800) 100%);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* ============================================
           LAYOUT
           ============================================ */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-4);
        }

        /* ============================================
           HEADER
           ============================================ */
        .app-header {
            text-align: center;
            padding: var(--space-8) var(--space-4);
            color: var(--color-neutral-100);
        }

        .app-title {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            margin-bottom: var(--space-2);
            background: linear-gradient(135deg, #fff 0%, #a8d8ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .app-subtitle {
            font-size: var(--font-size-sm);
            color: #8892b0;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Budget Update Banner */
        .update-banner {
            background: linear-gradient(135deg, rgba(250, 93, 41, 0.15) 0%, rgba(250, 93, 41, 0.05) 100%);
            border: 1px solid var(--color-accent-orange);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            margin: var(--space-4) 0;
            font-size: var(--font-size-sm);
            color: #fff;
        }

        .update-banner strong { color: var(--color-accent-orange); }

        /* ============================================
           WIZARD STEPPER
           ============================================ */
        .wizard-container {
            background: var(--color-neutral-100);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }

        .wizard-header {
            background: linear-gradient(135deg, var(--color-primary-800) 0%, var(--color-primary-900) 100%);
            padding: var(--space-6);
        }

        .wizard-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }

        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 40px;
            right: 40px;
            height: 3px;
            background: rgba(255,255,255,0.2);
            z-index: 0;
        }

        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
            z-index: 1;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: rgba(255,255,255,0.5);
            transition: var(--transition-base);
        }

        .step-label {
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.5);
            text-align: center;
            max-width: 80px;
            transition: var(--transition-base);
        }

        .wizard-step.active .step-circle {
            background: var(--color-accent-orange);
            border-color: var(--color-accent-orange);
            color: #fff;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(250, 93, 41, 0.5);
        }

        .wizard-step.active .step-label {
            color: #fff;
            font-weight: 600;
        }

        .wizard-step.completed .step-circle {
            background: var(--color-accent-green);
            border-color: var(--color-accent-green);
            color: #fff;
        }

        .wizard-step.completed .step-label {
            color: rgba(255,255,255,0.8);
        }

        .wizard-step.completed .step-circle::after {
            content: '‚úì';
        }

        .wizard-step.completed .step-number { display: none; }

        @media (max-width: 600px) {
            .wizard-steps { flex-wrap: wrap; gap: var(--space-4); }
            .wizard-steps::before { display: none; }
            .step-label { display: none; }
        }

        /* ============================================
           WIZARD CONTENT
           ============================================ */
        .wizard-content {
            padding: var(--space-8);
        }

        .wizard-step-content {
            display: none;
            animation: fadeIn 0.4s var(--easing-smooth);
        }

        .wizard-step-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-title {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-primary-900);
            margin-bottom: var(--space-2);
        }

        .step-description {
            font-size: var(--font-size-base);
            color: var(--color-neutral-500);
            margin-bottom: var(--space-6);
        }

        /* ============================================
           CARDS
           ============================================ */
        .card {
            background: var(--color-neutral-100);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-4);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-neutral-300);
            transition: var(--transition-base);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary-300);
        }

        .card-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-primary-900);
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 2px solid var(--color-neutral-300);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .card-title .icon {
            width: 24px;
            height: 24px;
            background: var(--color-primary-500);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: var(--font-size-sm);
        }

        /* ============================================
           ASSESSEE TYPE SELECTOR (Step 1)
           ============================================ */
        .assessee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .assessee-card {
            background: var(--color-neutral-200);
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .assessee-card:hover {
            background: var(--color-primary-100);
            border-color: var(--color-primary-300);
            transform: translateY(-2px);
        }

        .assessee-card.selected {
            background: linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-700) 100%);
            border-color: var(--color-primary-500);
            color: #fff;
            box-shadow: 0 4px 20px rgba(74, 144, 217, 0.3);
        }

        .assessee-icon {
            font-size: 2rem;
            margin-bottom: var(--space-2);
        }

        .assessee-label {
            font-weight: 600;
            font-size: var(--font-size-sm);
        }

        .assessee-desc {
            font-size: var(--font-size-xs);
            color: var(--color-neutral-500);
            margin-top: var(--space-1);
        }

        .assessee-card.selected .assessee-desc { color: rgba(255,255,255,0.8); }

        /* ============================================
           FORM ELEMENTS
           ============================================ */
        .form-row {
            display: grid;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .form-row.cols-2 { grid-template-columns: repeat(2, 1fr); }
        .form-row.cols-3 { grid-template-columns: repeat(3, 1fr); }
        .form-row.cols-4 { grid-template-columns: repeat(4, 1fr); }

        @media (max-width: 768px) {
            .form-row.cols-2,
            .form-row.cols-3,
            .form-row.cols-4 { grid-template-columns: 1fr; }
        }

        .form-group { margin-bottom: var(--space-4); }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--color-neutral-600);
            margin-bottom: var(--space-2);
            font-size: var(--font-size-sm);
        }

        .form-label .hint {
            font-weight: 400;
            color: var(--color-neutral-400);
            font-size: var(--font-size-xs);
        }

        .form-label .limit {
            display: block;
            color: var(--color-accent-orange);
            font-size: var(--font-size-xs);
            font-weight: 400;
            margin-top: var(--space-1);
        }

        .form-input, .form-select {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--color-neutral-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            background: var(--color-neutral-100);
            transition: var(--transition-fast);
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 4px rgba(74, 144, 217, 0.1);
        }

        .form-input.error { border-color: var(--color-accent-red); }
        .form-input.success { border-color: var(--color-accent-green); }

        .form-input::placeholder { color: var(--color-neutral-400); }

        /* Currency Input */
        .input-currency {
            position: relative;
        }

        .input-currency::before {
            content: '‚Çπ';
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-neutral-500);
            font-weight: 500;
        }

        .input-currency .form-input {
            padding-left: var(--space-8);
        }

        /* ============================================
           INCOME SOURCE CHECKBOXES (Step 2)
           ============================================ */
        .income-sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        .income-source-card {
            background: var(--color-neutral-200);
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
        }

        .income-source-card:hover {
            background: var(--color-primary-100);
            border-color: var(--color-primary-300);
        }

        .income-source-card.selected {
            background: linear-gradient(135deg, rgba(74, 144, 217, 0.1) 0%, rgba(74, 144, 217, 0.05) 100%);
            border-color: var(--color-primary-500);
        }

        .income-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--color-neutral-400);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition-fast);
        }

        .income-source-card.selected .income-checkbox {
            background: var(--color-primary-500);
            border-color: var(--color-primary-500);
            color: #fff;
        }

        .income-checkbox::after {
            content: '‚úì';
            opacity: 0;
            transform: scale(0);
            transition: var(--transition-fast);
        }

        .income-source-card.selected .income-checkbox::after {
            opacity: 1;
            transform: scale(1);
        }

        .income-source-info h4 {
            font-size: var(--font-size-base);
            font-weight: 600;
            color: var(--color-primary-900);
            margin-bottom: var(--space-1);
        }

        .income-source-info p {
            font-size: var(--font-size-xs);
            color: var(--color-neutral-500);
        }

        .income-source-icon {
            font-size: 1.5rem;
            margin-bottom: var(--space-1);
        }

        /* ============================================
           SECTION ACCORDIONS
           ============================================ */
        .section-accordion {
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            overflow: hidden;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4) var(--space-5);
            background: var(--color-neutral-200);
            cursor: pointer;
            transition: var(--transition-base);
        }

        .section-header:hover { background: var(--color-neutral-300); }

        .section-header h3 {
            font-size: var(--font-size-base);
            font-weight: 600;
            color: var(--color-primary-900);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .section-header .badge {
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .section-toggle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--color-primary-500);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-base);
        }

        .section-header.open .section-toggle { transform: rotate(180deg); }

        .section-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s var(--easing-smooth);
        }

        .section-body.open {
            max-height: 2000px;
        }

        .section-body-inner {
            padding: var(--space-5);
            border-top: 1px solid var(--color-neutral-300);
        }

        /* ============================================
           EVIDENCE BADGES (Business Expenses)
           ============================================ */
        .evidence-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .evidence-badge.tier-1 { background: rgba(76, 175, 80, 0.15); color: var(--tier-1); }
        .evidence-badge.tier-2 { background: rgba(33, 150, 243, 0.15); color: var(--tier-2); }
        .evidence-badge.tier-3 { background: rgba(255, 152, 0, 0.15); color: var(--tier-3); }
        .evidence-badge.tier-4 { background: rgba(255, 87, 34, 0.15); color: var(--tier-4); }
        .evidence-badge.tier-5 { background: rgba(244, 67, 54, 0.15); color: var(--tier-5); }

        .tds-warning {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            background: rgba(255, 193, 7, 0.15);
            color: #f57c00;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .deduction-badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-2);
            background: rgba(76, 175, 80, 0.15);
            color: var(--color-accent-green);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        /* ============================================
           EXPENSE CATEGORY (Business)
           ============================================ */
        .expense-category {
            background: var(--color-neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
            border-left: 4px solid var(--color-primary-500);
        }

        .expense-category-header {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .expense-category-number {
            width: 28px;
            height: 28px;
            background: var(--color-primary-500);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-sm);
            font-weight: 600;
        }

        .expense-category-title {
            font-size: var(--font-size-base);
            font-weight: 600;
            color: var(--color-primary-900);
        }

        .expense-category.tier-1 { border-left-color: var(--tier-1); }
        .expense-category.tier-2 { border-left-color: var(--tier-2); }
        .expense-category.tier-3 { border-left-color: var(--tier-3); }
        .expense-category.tier-4 { border-left-color: var(--tier-4); }
        .expense-category.tier-5 { border-left-color: var(--tier-5); }

        .expense-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
        }

        .expense-desc {
            font-size: var(--font-size-xs);
            color: var(--color-neutral-500);
            margin-bottom: var(--space-4);
        }

        .deduction-indicator {
            font-size: var(--font-size-xs);
            font-weight: 600;
            color: var(--color-accent-green);
            background: rgba(76, 175, 80, 0.1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
        }

        .deduction-indicator.caution {
            color: var(--color-accent-orange);
            background: rgba(250, 93, 41, 0.1);
        }

        .tds-badge {
            font-size: var(--font-size-xs);
            font-weight: 500;
            color: #fff;
            background: var(--color-accent-purple);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            margin-left: var(--space-1);
        }

        .business-type-section {
            transition: var(--transition-base);
        }

        .business-type-section.hidden {
            display: none;
        }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-6);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-base);
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-700) 100%);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 144, 217, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--color-accent-green) 0%, #388e3c 100%);
            color: #fff;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: var(--color-neutral-200);
            color: var(--color-neutral-600);
            border: 2px solid var(--color-neutral-300);
        }

        .btn-secondary:hover {
            background: var(--color-neutral-300);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--color-accent-red) 0%, #d32f2f 100%);
            color: #fff;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--color-primary-500);
            color: var(--color-primary-500);
        }

        .btn-outline:hover {
            background: var(--color-primary-500);
            color: #fff;
        }

        .btn-lg {
            padding: var(--space-4) var(--space-8);
            font-size: var(--font-size-lg);
        }

        .btn-sm {
            padding: var(--space-2) var(--space-4);
            font-size: var(--font-size-sm);
        }

        .btn-full { width: 100%; }

        /* ============================================
           WIZARD NAVIGATION
           ============================================ */
        .wizard-nav {
            display: flex;
            justify-content: space-between;
            padding-top: var(--space-6);
            border-top: 1px solid var(--color-neutral-300);
            margin-top: var(--space-6);
        }

        /* ============================================
           ALERTS & INFO BOXES
           ============================================ */
        .alert {
            padding: var(--space-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
            font-size: var(--font-size-sm);
        }

        .alert-info {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid var(--color-old-regime);
            color: #1565c0;
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--color-accent-green);
            color: #2e7d32;
        }

        .alert-warning {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid var(--color-accent-yellow);
            color: #e65100;
        }

        .alert-danger {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid var(--color-accent-red);
            color: #c62828;
        }

        /* ============================================
           RESULTS COMPARISON
           ============================================ */
        .results-comparison {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-6);
            margin-bottom: var(--space-6);
        }

        @media (max-width: 768px) {
            .results-comparison { grid-template-columns: 1fr; }
        }

        .regime-card {
            background: var(--color-neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            position: relative;
            transition: var(--transition-base);
        }

        .regime-card.recommended {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%);
            border: 2px solid var(--color-accent-green);
        }

        .regime-card.recommended::before {
            content: '‚úì RECOMMENDED';
            position: absolute;
            top: -12px;
            right: var(--space-4);
            background: var(--color-accent-green);
            color: #fff;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .regime-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-primary-900);
            margin-bottom: var(--space-4);
        }

        .tax-amount {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-primary-900);
        }

        .tax-label {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-500);
            margin-bottom: var(--space-4);
        }

        .tax-breakdown {
            border-top: 1px solid var(--color-neutral-300);
            padding-top: var(--space-4);
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-2) 0;
            font-size: var(--font-size-sm);
        }

        .breakdown-row span:first-child { color: var(--color-neutral-500); }
        .breakdown-row span:last-child { font-weight: 500; }

        .savings-banner {
            background: linear-gradient(135deg, var(--color-accent-green) 0%, #388e3c 100%);
            color: #fff;
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .savings-amount {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: var(--space-2);
        }

        /* ============================================
           SUMMARY CARDS (Step 5)
           ============================================ */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .summary-card {
            background: var(--color-neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            text-align: center;
        }

        .summary-card-label {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-500);
            margin-bottom: var(--space-2);
        }

        .summary-card-value {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--color-primary-900);
        }

        /* ============================================
           TABLES
           ============================================ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        .data-table th, .data-table td {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            border-bottom: 1px solid var(--color-neutral-300);
        }

        .data-table th {
            background: var(--color-primary-900);
            color: #fff;
            font-weight: 600;
        }

        .data-table tr:nth-child(even) { background: var(--color-neutral-200); }
        .data-table tr:hover { background: var(--color-primary-100); }

        /* ============================================
           HIDDEN UTILITY
           ============================================ */
        .hidden { display: none !important; }

        /* ============================================
           DISCLAIMER
           ============================================ */
        .disclaimer {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid var(--color-accent-yellow);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-top: var(--space-6);
            font-size: var(--font-size-sm);
            color: #856404;
        }

        /* ============================================
           ACCESSIBILITY
           ============================================ */
        /* Skip to main content link */
        .skip-link {
            position: absolute;
            top: -100px;
            left: 0;
            background: var(--color-primary-900);
            color: #fff;
            padding: var(--space-3) var(--space-4);
            z-index: 1000;
            border-radius: var(--radius-md);
            text-decoration: none;
            font-weight: 600;
        }

        .skip-link:focus {
            top: var(--space-2);
            left: var(--space-2);
        }

        /* Enhanced focus styles */
        :focus-visible {
            outline: 3px solid var(--color-accent-orange);
            outline-offset: 2px;
        }

        .form-input:focus-visible,
        .form-select:focus-visible {
            outline: none;
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 4px rgba(74, 144, 217, 0.25);
        }

        .btn:focus-visible {
            outline-offset: 3px;
        }

        .assessee-card:focus-visible,
        .income-source-card:focus-visible {
            outline: 3px solid var(--color-accent-orange);
            outline-offset: 2px;
        }

        /* Screen reader only text */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode adjustments */
        @media (prefers-contrast: high) {
            .form-input, .form-select {
                border-width: 3px;
            }
            .card {
                border-width: 2px;
            }
        }

        /* ============================================
           PRINT STYLES
           ============================================ */
        @media print {
            body { background: #fff; }
            .wizard-header, .wizard-nav, .btn, .skip-link { display: none; }
            .wizard-container { box-shadow: none; }
            .depreciation-tool, .indexation-tool { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">Indian Income Tax Calculator</h1>
            <p class="app-subtitle">FY 2024-25 (AY 2025-26) | Budget 2024 Updated Rates | Complete ITR Tool</p>

            <div class="update-banner">
                <strong>Budget 2024 Updates (Effective 23 July 2024):</strong>
                STCG on Equity: 15% ‚Üí <strong>20%</strong> |
                LTCG on Equity: 10% ‚Üí <strong>12.5%</strong> (Exemption: ‚Çπ1L ‚Üí <strong>‚Çπ1.25L</strong>) |
                Other LTCG: 20% with indexation ‚Üí <strong>12.5% without indexation</strong>
            </div>
        </header>

        <!-- Wizard Container -->
        <main id="main-content" class="wizard-container" role="main">
            <!-- Wizard Steps Header -->
            <nav class="wizard-header" aria-label="Tax calculation steps">
                <ol class="wizard-steps" role="list">
                    <li class="wizard-step active" data-step="1" onclick="goToStep(1)" tabindex="0" role="button" aria-current="step" aria-label="Step 1: Profile Setup">
                        <div class="step-circle" aria-hidden="true"><span class="step-number">1</span></div>
                        <div class="step-label">Profile</div>
                    </li>
                    <li class="wizard-step" data-step="2" onclick="goToStep(2)" tabindex="0" role="button" aria-label="Step 2: Income Sources">
                        <div class="step-circle" aria-hidden="true"><span class="step-number">2</span></div>
                        <div class="step-label">Income Sources</div>
                    </li>
                    <li class="wizard-step" data-step="3" onclick="goToStep(3)" tabindex="0" role="button" aria-label="Step 3: Income Details">
                        <div class="step-circle" aria-hidden="true"><span class="step-number">3</span></div>
                        <div class="step-label">Income Details</div>
                    </li>
                    <li class="wizard-step" data-step="4" onclick="goToStep(4)" tabindex="0" role="button" aria-label="Step 4: Deductions">
                        <div class="step-circle" aria-hidden="true"><span class="step-number">4</span></div>
                        <div class="step-label">Deductions</div>
                    </li>
                    <li class="wizard-step" data-step="5" onclick="goToStep(5)" tabindex="0" role="button" aria-label="Step 5: Results">
                        <div class="step-circle" aria-hidden="true"><span class="step-number">5</span></div>
                        <div class="step-label">Results</div>
                    </li>
                </ol>
            </nav>

            <!-- Wizard Content -->
            <div class="wizard-content">
                <!-- STEP 1: Profile Setup -->
                <div class="wizard-step-content active" id="step-1">
                    <h2 class="step-title">Profile Setup</h2>
                    <p class="step-description">Tell us about yourself to determine the applicable tax rules and ITR form.</p>

                    <!-- Assessee Type -->
                    <div class="card">
                        <h3 class="card-title"><span class="icon">üë§</span> Assessee Type</h3>
                        <div class="assessee-grid">
                            <div class="assessee-card selected" data-type="individual" onclick="selectAssesseeType(this)">
                                <div class="assessee-icon">üë§</div>
                                <div class="assessee-label">Individual</div>
                                <div class="assessee-desc">Salaried, Self-employed</div>
                            </div>
                            <div class="assessee-card" data-type="huf" onclick="selectAssesseeType(this)">
                                <div class="assessee-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                                <div class="assessee-label">HUF</div>
                                <div class="assessee-desc">Hindu Undivided Family</div>
                            </div>
                            <div class="assessee-card" data-type="firm" onclick="selectAssesseeType(this)">
                                <div class="assessee-icon">ü§ù</div>
                                <div class="assessee-label">Firm</div>
                                <div class="assessee-desc">Partnership Firm</div>
                            </div>
                            <div class="assessee-card" data-type="llp" onclick="selectAssesseeType(this)">
                                <div class="assessee-icon">üè¢</div>
                                <div class="assessee-label">LLP</div>
                                <div class="assessee-desc">Limited Liability Partnership</div>
                            </div>
                            <div class="assessee-card" data-type="company" onclick="selectAssesseeType(this)">
                                <div class="assessee-icon">üèõÔ∏è</div>
                                <div class="assessee-label">Company</div>
                                <div class="assessee-desc">Private / Public Ltd</div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Details -->
                    <div class="card" id="individual-details">
                        <h3 class="card-title"><span class="icon">üìã</span> Additional Details</h3>
                        <div class="form-row cols-3">
                            <div class="form-group">
                                <label class="form-label">Residential Status</label>
                                <select class="form-select" id="residentialStatus">
                                    <option value="resident">Resident</option>
                                    <option value="nonresident">Non-Resident</option>
                                    <option value="rnor">Resident but Not Ordinarily Resident</option>
                                </select>
                            </div>
                            <div class="form-group" id="age-group-field">
                                <label class="form-label">Age Group</label>
                                <select class="form-select" id="ageGroup">
                                    <option value="general">Below 60 years</option>
                                    <option value="senior">60-80 years (Senior Citizen)</option>
                                    <option value="supersenior">Above 80 years (Super Senior)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Financial Year</label>
                                <select class="form-select" id="financialYear">
                                    <option value="2024-25" selected>FY 2024-25 (AY 2025-26)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Regime Comparison Info -->
                    <div class="alert alert-info" style="margin-bottom: var(--space-6);">
                        <strong>üìä Comparison Tool:</strong> This calculator compares BOTH tax regimes and recommends the one with lower tax liability. Enter your deductions in Step 4 to see accurate comparison.
                    </div>

                    <!-- Navigation -->
                    <div class="wizard-nav">
                        <div></div>
                        <button class="btn btn-primary btn-lg" onclick="nextStep()">
                            Continue to Income Sources ‚Üí
                        </button>
                    </div>
                </div>

                <!-- STEP 2: Income Sources -->
                <div class="wizard-step-content" id="step-2">
                    <h2 class="step-title">Select Your Income Sources</h2>
                    <p class="step-description">Choose which types of income you have. We'll only show relevant sections based on your selection.</p>

                    <div class="alert alert-info">
                        <strong>Tip:</strong> Select all applicable income sources. The calculator will determine the appropriate ITR form based on your selections.
                    </div>

                    <div class="income-sources-grid">
                        <div class="income-source-card" data-source="salary" onclick="toggleIncomeSource(this)">
                            <div class="income-checkbox"></div>
                            <div class="income-source-info">
                                <div class="income-source-icon">üíº</div>
                                <h4>Salary Income</h4>
                                <p>Employment income, allowances, perquisites, pension</p>
                            </div>
                        </div>
                        <div class="income-source-card" data-source="house" onclick="toggleIncomeSource(this)">
                            <div class="income-checkbox"></div>
                            <div class="income-source-info">
                                <div class="income-source-icon">üè†</div>
                                <h4>House Property</h4>
                                <p>Rental income, home loan interest deduction</p>
                            </div>
                        </div>
                        <div class="income-source-card" data-source="business" onclick="toggleIncomeSource(this)">
                            <div class="income-checkbox"></div>
                            <div class="income-source-info">
                                <div class="income-source-icon">üìä</div>
                                <h4>Business / Profession</h4>
                                <p>Self-employed, freelance, trading, professional fees</p>
                            </div>
                        </div>
                        <div class="income-source-card" data-source="capital" onclick="toggleIncomeSource(this)">
                            <div class="income-checkbox"></div>
                            <div class="income-source-info">
                                <div class="income-source-icon">üìà</div>
                                <h4>Capital Gains</h4>
                                <p>Stocks, mutual funds, property sale, crypto</p>
                            </div>
                        </div>
                        <div class="income-source-card" data-source="other" onclick="toggleIncomeSource(this)">
                            <div class="income-checkbox"></div>
                            <div class="income-source-info">
                                <div class="income-source-icon">üí∞</div>
                                <h4>Other Sources</h4>
                                <p>Interest, dividends, lottery, gifts, royalty</p>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning hidden" id="no-source-warning">
                        Please select at least one income source to continue.
                    </div>

                    <!-- Navigation -->
                    <div class="wizard-nav">
                        <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
                        <button class="btn btn-primary btn-lg" onclick="nextStep()">
                            Continue to Income Details ‚Üí
                        </button>
                    </div>
                </div>

                <!-- STEP 3: Income Details (Placeholder - will be dynamically populated) -->
                <div class="wizard-step-content" id="step-3">
                    <h2 class="step-title">Enter Income Details</h2>
                    <p class="step-description">Fill in the details for each income source you selected.</p>

                    <div id="income-sections-container">
                        <!-- Dynamically populated based on Step 2 selections -->
                        <div class="alert alert-info">
                            Please complete Step 2 first to see relevant income sections.
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="wizard-nav">
                        <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
                        <button class="btn btn-primary btn-lg" onclick="nextStep()">
                            Continue to Deductions ‚Üí
                        </button>
                    </div>
                </div>

                <!-- STEP 4: Deductions -->
                <div class="wizard-step-content" id="step-4">
                    <h2 class="step-title">Claim Deductions</h2>
                    <p class="step-description">Enter your investments and expenses to reduce taxable income under Old Tax Regime.</p>

                    <div class="alert alert-warning" id="deductions-new-regime-warning">
                        <strong>Note:</strong> You've selected New Tax Regime. Most deductions below are not available in the New Regime.
                        Switch to Old Regime in Step 1 if you want to claim these deductions.
                    </div>

                    <div id="deductions-container">
                        <!-- Deduction sections will be populated here -->
                        <div class="alert alert-info">
                            Deductions will be shown based on your selected tax regime.
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="wizard-nav">
                        <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
                        <button class="btn btn-success btn-lg" onclick="calculateAndShowResults()">
                            Calculate Tax ‚Üí
                        </button>
                    </div>
                </div>

                <!-- STEP 5: Results -->
                <div class="wizard-step-content" id="step-5">
                    <h2 class="step-title">Your Tax Summary</h2>
                    <p class="step-description">Compare tax liability under both regimes and see which one saves you more.</p>

                    <!-- Summary Cards -->
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-card-label">Gross Total Income</div>
                            <div class="summary-card-value" id="summary-gti">‚Çπ0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-label">Total Deductions</div>
                            <div class="summary-card-value" id="summary-deductions">‚Çπ0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-label">Taxable Income (Old)</div>
                            <div class="summary-card-value" id="summary-taxable-old">‚Çπ0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-label">Taxable Income (New)</div>
                            <div class="summary-card-value" id="summary-taxable-new">‚Çπ0</div>
                        </div>
                    </div>

                    <!-- Regime Comparison -->
                    <div class="results-comparison">
                        <div class="regime-card" id="new-regime-result">
                            <h3 class="regime-title" style="color: var(--color-new-regime);">New Tax Regime</h3>
                            <div class="tax-amount" id="new-tax-total">‚Çπ0</div>
                            <div class="tax-label">Total Tax Payable</div>
                            <div class="tax-breakdown">
                                <div class="breakdown-row">
                                    <span>Basic Tax</span>
                                    <span id="new-basic-tax">‚Çπ0</span>
                                </div>
                                <div class="breakdown-row">
                                    <span>Surcharge</span>
                                    <span id="new-surcharge">‚Çπ0</span>
                                </div>
                                <div class="breakdown-row">
                                    <span>Marginal Relief</span>
                                    <span id="new-marginal">‚Çπ0</span>
                                </div>
                                <div class="breakdown-row">
                                    <span>Health & Education Cess (4%)</span>
                                    <span id="new-cess">‚Çπ0</span>
                                </div>
                            </div>
                        </div>
                        <div class="regime-card" id="old-regime-result">
                            <h3 class="regime-title" style="color: var(--color-old-regime);">Old Tax Regime</h3>
                            <div class="tax-amount" id="old-tax-total">‚Çπ0</div>
                            <div class="tax-label">Total Tax Payable</div>
                            <div class="tax-breakdown">
                                <div class="breakdown-row">
                                    <span>Basic Tax</span>
                                    <span id="old-basic-tax">‚Çπ0</span>
                                </div>
                                <div class="breakdown-row">
                                    <span>Surcharge</span>
                                    <span id="old-surcharge">‚Çπ0</span>
                                </div>
                                <div class="breakdown-row">
                                    <span>Marginal Relief</span>
                                    <span id="old-marginal">‚Çπ0</span>
                                </div>
                                <div class="breakdown-row">
                                    <span>Health & Education Cess (4%)</span>
                                    <span id="old-cess">‚Çπ0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Savings Banner -->
                    <div class="savings-banner" id="savings-banner">
                        <div class="savings-amount" id="savings-amount">You Save ‚Çπ0</div>
                        <div id="savings-text">by choosing the recommended tax regime</div>
                    </div>

                    <!-- Actions -->
                    <!-- Form 26AS TDS Reconciliation -->
                    <div class="card" style="margin-top: var(--space-8);">
                        <h3 class="card-title"><span class="icon">üìã</span> Form 26AS / AIS Reconciliation</h3>
                        <p style="font-size: var(--font-size-sm); color: var(--color-neutral-500); margin-bottom: var(--space-4);">
                            Enter TDS amounts from your Form 26AS/AIS to calculate your final tax payable or refund due.
                        </p>

                        <div class="form-row cols-3">
                            <div class="form-group">
                                <label class="form-label">
                                    TDS on Salary (Sec 192)
                                    <span class="hint">From Form 16</span>
                                </label>
                                <div class="input-currency">
                                    <input type="number" class="form-input" id="tds192" placeholder="0" value="0" oninput="updateTDSReconciliation()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    TDS on Interest (Sec 194A)
                                    <span class="hint">FD, RD interest</span>
                                </label>
                                <div class="input-currency">
                                    <input type="number" class="form-input" id="tds194A" placeholder="0" value="0" oninput="updateTDSReconciliation()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    TDS on Dividends (Sec 194)
                                    <span class="hint">From companies</span>
                                </label>
                                <div class="input-currency">
                                    <input type="number" class="form-input" id="tds194" placeholder="0" value="0" oninput="updateTDSReconciliation()">
                                </div>
                            </div>
                        </div>
                        <div class="form-row cols-3">
                            <div class="form-group">
                                <label class="form-label">
                                    TDS on Professional Fees (Sec 194J)
                                    <span class="hint">Freelance income</span>
                                </label>
                                <div class="input-currency">
                                    <input type="number" class="form-input" id="tds194J" placeholder="0" value="0" oninput="updateTDSReconciliation()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    TDS on Rent (Sec 194I/194IB)
                                    <span class="hint">Rental income</span>
                                </label>
                                <div class="input-currency">
                                    <input type="number" class="form-input" id="tds194I" placeholder="0" value="0" oninput="updateTDSReconciliation()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Other TDS / TCS
                                    <span class="hint">Any other deductions</span>
                                </label>
                                <div class="input-currency">
                                    <input type="number" class="form-input" id="tdsOther" placeholder="0" value="0" oninput="updateTDSReconciliation()">
                                </div>
                            </div>
                        </div>
                        <div class="form-row cols-2">
                            <div class="form-group">
                                <label class="form-label">
                                    Advance Tax Paid
                                    <span class="hint">Self-assessment payments</span>
                                </label>
                                <div class="input-currency">
                                    <input type="number" class="form-input" id="advanceTax" placeholder="0" value="0" oninput="updateTDSReconciliation()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Self-Assessment Tax (Challan 280)
                                    <span class="hint">Tax paid before filing</span>
                                </label>
                                <div class="input-currency">
                                    <input type="number" class="form-input" id="selfAssessment" placeholder="0" value="0" oninput="updateTDSReconciliation()">
                                </div>
                            </div>
                        </div>

                        <!-- Reconciliation Summary -->
                        <div id="tds-reconciliation-summary" style="margin-top: var(--space-4); padding: var(--space-4); border-radius: var(--radius-md); background: var(--color-neutral-200);">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-4); text-align: center;">
                                <div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-neutral-500);">Total Tax Liability</div>
                                    <div id="recTaxLiability" style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-accent-red);">‚Çπ0</div>
                                </div>
                                <div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-neutral-500);">Total TDS/Tax Paid</div>
                                    <div id="recTotalPaid" style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-accent-green);">‚Çπ0</div>
                                </div>
                                <div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-neutral-500);">Balance</div>
                                    <div id="recBalance" style="font-size: var(--font-size-xl); font-weight: 700;">‚Çπ0</div>
                                </div>
                            </div>
                            <div id="recMessage" style="margin-top: var(--space-4); padding: var(--space-3); border-radius: var(--radius-md); text-align: center; font-weight: 600;"></div>
                        </div>
                    </div>

                    <div style="display: flex; gap: var(--space-4); justify-content: center; margin-top: var(--space-6);">
                        <button class="btn btn-primary" onclick="exportToPDF()">üìÑ Export PDF</button>
                        <button class="btn btn-outline" onclick="window.print()">üñ®Ô∏è Print</button>
                        <button class="btn btn-secondary" onclick="goToStep(1)">üîÑ Start Over</button>
                    </div>

                    <!-- Disclaimer -->
                    <div class="disclaimer">
                        <strong>Disclaimer:</strong> This calculator provides estimates based on Income Tax Act FY 2024-25 (Budget 2024 updated).
                        Consult a qualified CA for accurate filing. Special rates apply for Capital Gains and Lottery income.
                        Marginal relief may apply at surcharge thresholds.
                    </div>

                    <!-- Navigation -->
                    <div class="wizard-nav">
                        <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back to Deductions</button>
                        <div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const TaxState = {
            currentStep: 1,
            assesseeType: 'individual',
            residentialStatus: 'resident',
            ageGroup: 'general',
            financialYear: '2024-25',

            incomeSources: {
                salary: false,
                house: false,
                business: false,
                capital: false,
                other: false
            },

            // Income data will be added as user fills forms
            salary: {},
            house: { properties: [] },
            business: { type: 'none' },
            capital: {},
            other: {},

            deductions: {},
            assets: [],
            results: null
        };

        // ============================================
        // CONFIGURATION
        // ============================================
        const TaxConfig = {
            CII_TABLE: {
                '2001-02': 100, '2002-03': 105, '2003-04': 109, '2004-05': 113,
                '2005-06': 117, '2006-07': 122, '2007-08': 129, '2008-09': 137,
                '2009-10': 148, '2010-11': 167, '2011-12': 184, '2012-13': 200,
                '2013-14': 220, '2014-15': 240, '2015-16': 254, '2016-17': 264,
                '2017-18': 272, '2018-19': 280, '2019-20': 289, '2020-21': 301,
                '2021-22': 317, '2022-23': 331, '2023-24': 348, '2024-25': 363
            },

            DEP_RATES: {
                'building5': { name: 'Building (Residential)', rate: 0.05 },
                'building10': { name: 'Building (Others)', rate: 0.10 },
                'furniture': { name: 'Furniture & Fittings', rate: 0.10 },
                'plant15': { name: 'Plant & Machinery', rate: 0.15 },
                'vehicle15': { name: 'Motor Vehicles', rate: 0.15 },
                'vehicle30': { name: 'Commercial Vehicles', rate: 0.30 },
                'computer': { name: 'Computers & Software', rate: 0.40 },
                'intangible': { name: 'Intangible Assets', rate: 0.25 },
                'energy': { name: 'Energy Saving Devices', rate: 0.40 }
            },

            DEDUCTION_LIMITS: {
                '80C': 150000,
                '80CCD1B': 50000,
                '80D_self_general': 25000,
                '80D_self_senior': 50000,
                '80D_parents': 50000,
                '80TTA': 10000,
                '80TTB': 50000,
                '80E': Infinity,
                '80EE': 50000,
                '80G': Infinity
            }
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function formatCurrency(amount) {
            return '‚Çπ' + Math.round(amount).toLocaleString('en-IN');
        }

        function getVal(id) {
            const el = document.getElementById(id);
            return el ? (parseFloat(el.value) || 0) : 0;
        }

        function saveState() {
            localStorage.setItem('indianTaxCalculator_v2', JSON.stringify(TaxState));
        }

        function loadState() {
            const saved = localStorage.getItem('indianTaxCalculator_v2');
            if (saved) {
                try {
                    Object.assign(TaxState, JSON.parse(saved));
                } catch (e) {
                    console.log('Could not load saved state');
                }
            }
        }

        // ============================================
        // WIZARD NAVIGATION
        // ============================================
        function goToStep(step) {
            if (step < 1 || step > 5) return;

            // Update state
            TaxState.currentStep = step;

            // Update step indicators
            document.querySelectorAll('.wizard-step').forEach((el, index) => {
                el.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    el.classList.add('completed');
                } else if (index + 1 === step) {
                    el.classList.add('active');
                }
            });

            // Show correct content
            document.querySelectorAll('.wizard-step-content').forEach((el, index) => {
                el.classList.remove('active');
                if (index + 1 === step) {
                    el.classList.add('active');
                }
            });

            // Special handling for each step
            if (step === 3) {
                renderIncomeSections();
            } else if (step === 4) {
                renderDeductionsSections();
            } else if (step === 5) {
                calculateAndShowResults();
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            saveState();
        }

        function nextStep() {
            // Validation for step 2
            if (TaxState.currentStep === 2) {
                const hasSource = Object.values(TaxState.incomeSources).some(v => v);
                if (!hasSource) {
                    document.getElementById('no-source-warning').classList.remove('hidden');
                    return;
                }
                document.getElementById('no-source-warning').classList.add('hidden');
            }

            goToStep(TaxState.currentStep + 1);
        }

        function prevStep() {
            goToStep(TaxState.currentStep - 1);
        }

        // ============================================
        // STEP 1: PROFILE SETUP
        // ============================================
        function selectAssesseeType(element) {
            // Update UI
            document.querySelectorAll('.assessee-card').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');

            // Update state
            TaxState.assesseeType = element.dataset.type;

            // Show/hide age group based on type
            const ageField = document.getElementById('age-group-field');
            if (TaxState.assesseeType === 'individual') {
                ageField.classList.remove('hidden');
            } else {
                ageField.classList.add('hidden');
            }

            saveState();
        }

        // ============================================
        // STEP 2: INCOME SOURCE SELECTION
        // ============================================
        function toggleIncomeSource(element) {
            const source = element.dataset.source;

            // Toggle selection
            element.classList.toggle('selected');
            TaxState.incomeSources[source] = element.classList.contains('selected');

            // Hide warning if at least one source selected
            const hasSource = Object.values(TaxState.incomeSources).some(v => v);
            if (hasSource) {
                document.getElementById('no-source-warning').classList.add('hidden');
            }

            saveState();
        }

        // ============================================
        // STEP 3: INCOME DETAILS (Dynamic Rendering)
        // ============================================
        function renderIncomeSections() {
            const container = document.getElementById('income-sections-container');
            let html = '';

            if (TaxState.incomeSources.salary) {
                html += renderSalarySection();
            }
            if (TaxState.incomeSources.house) {
                html += renderHousePropertySection();
            }
            if (TaxState.incomeSources.business) {
                html += renderBusinessSection();
            }
            if (TaxState.incomeSources.capital) {
                html += renderCapitalGainsSection();
            }
            if (TaxState.incomeSources.other) {
                html += renderOtherSourcesSection();
            }

            if (!html) {
                html = '<div class="alert alert-warning">Please go back to Step 2 and select at least one income source.</div>';
            }

            container.innerHTML = html;
            attachInputListeners();
        }

        function renderSalarySection() {
            return `
                <div class="section-accordion">
                    <div class="section-header open" onclick="toggleSectionAccordion(this)">
                        <h3>üíº Salary Income (Section 15-17)</h3>
                        <div class="section-toggle">‚ñº</div>
                    </div>
                    <div class="section-body open">
                        <div class="section-body-inner">
                            <div class="form-row cols-2">
                                <div class="form-group">
                                    <label class="form-label">Basic Salary (Annual)</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="basicSalary" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Dearness Allowance (DA)</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="da" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="form-row cols-3">
                                <div class="form-group">
                                    <label class="form-label">House Rent Allowance (HRA)</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="hra" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Actual Rent Paid (Annual)</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="actualRent" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">City Type</label>
                                    <select class="form-select" id="cityType">
                                        <option value="metro">Metro (50%)</option>
                                        <option value="nonmetro">Non-Metro (40%)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row cols-3">
                                <div class="form-group">
                                    <label class="form-label">Leave Travel Allowance (LTA)</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="lta" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Special Allowances (Taxable)</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="specialAllowance" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bonus / Commission</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="salaryBonus" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="form-row cols-2">
                                <div class="form-group">
                                    <label class="form-label">Employer's PF Contribution</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="employerPF" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Perquisites Value (Sec 17(2))</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="perquisites" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-success" id="salary-summary">
                                <strong>Salary Summary:</strong> Gross: ‚Çπ0 | HRA Exemption: ‚Çπ0 | <strong>Net Taxable: ‚Çπ0</strong>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHousePropertySection() {
            return `
                <div class="section-accordion">
                    <div class="section-header" onclick="toggleSectionAccordion(this)">
                        <h3>üè† House Property Income (Section 22-27)</h3>
                        <div class="section-toggle">‚ñº</div>
                    </div>
                    <div class="section-body">
                        <div class="section-body-inner">
                            <div class="form-row cols-2">
                                <div class="form-group">
                                    <label class="form-label">Property Type</label>
                                    <select class="form-select" id="propertyType">
                                        <option value="selfoccupied">Self-Occupied</option>
                                        <option value="letout">Let Out</option>
                                        <option value="deemed">Deemed Let Out</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Annual Rent Received</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="annualRent" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="form-row cols-2">
                                <div class="form-group">
                                    <label class="form-label">Municipal Taxes Paid</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="municipalTax" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        Home Loan Interest (Sec 24b)
                                        <span class="limit">Max ‚Çπ2L for self-occupied</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="homeLoanInterest" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-success" id="house-summary">
                                <strong>House Property:</strong> Net Income: ‚Çπ0
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderBusinessSection() {
            return `
                <div class="section-accordion">
                    <div class="section-header open" onclick="toggleSectionAccordion(this)">
                        <h3>üìä Business / Profession Income (Section 28-44)</h3>
                        <div class="section-toggle">‚ñº</div>
                    </div>
                    <div class="section-body open">
                        <div class="section-body-inner">
                            <div class="form-group">
                                <label class="form-label">Business Type</label>
                                <select class="form-select" id="businessType" onchange="toggleBusinessType()">
                                    <option value="presumptive44AD">Presumptive - Sec 44AD (Business up to ‚Çπ3Cr)</option>
                                    <option value="presumptive44ADA">Presumptive - Sec 44ADA (Profession up to ‚Çπ75L)</option>
                                    <option value="presumptive44AE">Presumptive - Sec 44AE (Goods Transport)</option>
                                    <option value="regular">Regular Business (Maintain Books)</option>
                                </select>
                            </div>

                            <!-- Presumptive 44AD -->
                            <div id="section-44ad" class="business-type-section">
                                <div class="alert alert-info">
                                    <strong>Section 44AD:</strong> For eligible businesses with turnover up to ‚Çπ3Cr (if 95% digital) or ‚Çπ2Cr.
                                    <br>Digital receipts taxed at 6%, cash at 8% of turnover.
                                </div>
                                <div class="form-row cols-2">
                                    <div class="form-group">
                                        <label class="form-label">Total Gross Turnover / Receipts</label>
                                        <div class="input-currency">
                                            <input type="number" class="form-input" id="turnover44AD" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            Digital Receipts (Bank/UPI)
                                            <span class="hint">Taxed at 6% rate</span>
                                        </label>
                                        <div class="input-currency">
                                            <input type="number" class="form-input" id="digital44AD" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Presumptive 44ADA -->
                            <div id="section-44ada" class="business-type-section hidden">
                                <div class="alert alert-info">
                                    <strong>Section 44ADA:</strong> For professionals (doctors, lawyers, architects, CAs, etc.) with gross receipts up to ‚Çπ75L.
                                    <br>50% of receipts treated as profit.
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Gross Professional Receipts</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="receipts44ADA" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                    </div>
                                </div>
                            </div>

                            <!-- Presumptive 44AE -->
                            <div id="section-44ae" class="business-type-section hidden">
                                <div class="alert alert-info">
                                    <strong>Section 44AE:</strong> For goods carriage owners (up to 10 vehicles).
                                    <br>Heavy: ‚Çπ1,000/ton/month | Light: ‚Çπ7,500/vehicle/month
                                </div>
                                <div class="form-row cols-2">
                                    <div class="form-group">
                                        <label class="form-label">Heavy Vehicles (Tons capacity)</label>
                                        <input type="number" class="form-input" id="heavyVehicleTons" placeholder="Total tons" value="0" oninput="updateBusinessSummary()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Light Vehicles (Count)</label>
                                        <input type="number" class="form-input" id="lightVehicleCount" placeholder="Number of vehicles" value="0" oninput="updateBusinessSummary()">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Months Operated (1-12)</label>
                                    <input type="number" class="form-input" id="vehicleMonths" placeholder="12" value="12" min="1" max="12" oninput="updateBusinessSummary()">
                                </div>
                            </div>

                            <!-- Regular Business with Expense Tracking -->
                            <div id="section-regular" class="business-type-section hidden">
                                <div class="alert alert-warning">
                                    <strong>Regular Books:</strong> Maintain proper books of accounts. Audit required if turnover exceeds ‚Çπ1Cr (‚Çπ10Cr if 95% digital).
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Gross Business Income / Receipts</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="grossBusinessIncome" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                    </div>
                                </div>

                                <h4 style="margin: var(--space-6) 0 var(--space-4); color: var(--color-primary-900); border-bottom: 2px solid var(--color-neutral-300); padding-bottom: var(--space-2);">
                                    Business Expenses <span style="font-weight: normal; font-size: var(--font-size-sm); color: var(--color-neutral-500);">(Ordered by Audit Evidence Strength)</span>
                                </h4>

                                <!-- TIER 1: Bank/Electronic Evidence (Strongest) -->
                                <div class="expense-category tier-1">
                                    <div class="expense-header">
                                        <span class="evidence-badge tier-1">üè¶ Tier 1: Bank Evidence</span>
                                        <span class="deduction-indicator">100% Deductible</span>
                                    </div>
                                    <p class="expense-desc">Expenses with clear bank statements/electronic trail - strongest audit evidence</p>

                                    <div class="form-row cols-2">
                                        <div class="form-group">
                                            <label class="form-label">
                                                Salaries & Wages <span class="tds-badge">TDS 194C</span>
                                            </label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expSalaries" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                Rent Paid <span class="tds-badge">TDS 194I</span>
                                                <span class="limit">TDS if >‚Çπ2.4L/year</span>
                                            </label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expRent" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row cols-2">
                                        <div class="form-group">
                                            <label class="form-label">
                                                Professional / Legal Fees <span class="tds-badge">TDS 194J</span>
                                            </label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expProfessional" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                Interest on Business Loans <span class="tds-badge">TDS 194A</span>
                                            </label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expInterest" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- TIER 2: GST Invoice Evidence -->
                                <div class="expense-category tier-2">
                                    <div class="expense-header">
                                        <span class="evidence-badge tier-2">üìã Tier 2: GST Invoices</span>
                                        <span class="deduction-indicator">100% Deductible</span>
                                    </div>
                                    <p class="expense-desc">Expenses with proper GST invoices - verified via GSTR-2A/2B</p>

                                    <div class="form-row cols-3">
                                        <div class="form-group">
                                            <label class="form-label">Electricity & Utilities</label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expUtilities" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Telephone & Internet</label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expTelephone" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Materials & Supplies</label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expMaterials" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row cols-2">
                                        <div class="form-group">
                                            <label class="form-label">Marketing & Advertising</label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expMarketing" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Software & Subscriptions</label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expSoftware" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- TIER 3: Agreement/Bill Evidence -->
                                <div class="expense-category tier-3">
                                    <div class="expense-header">
                                        <span class="evidence-badge tier-3">üìÑ Tier 3: Agreements/Bills</span>
                                        <span class="deduction-indicator">100% Deductible</span>
                                    </div>
                                    <p class="expense-desc">Expenses with signed agreements or proper bills - require supporting documents</p>

                                    <div class="form-row cols-3">
                                        <div class="form-group">
                                            <label class="form-label">Travel & Conveyance</label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expTravel" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Repairs & Maintenance</label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expRepairs" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Insurance Premiums</label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expInsurance" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row cols-2">
                                        <div class="form-group">
                                            <label class="form-label">Printing & Stationery</label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expStationery" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Staff Welfare</label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expWelfare" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- TIER 4: Computed/Calculated -->
                                <div class="expense-category tier-4">
                                    <div class="expense-header">
                                        <span class="evidence-badge tier-4">üî¢ Tier 4: Computed</span>
                                        <span class="deduction-indicator">Per IT Act Rules</span>
                                    </div>
                                    <p class="expense-desc">Calculated deductions based on asset register - requires depreciation schedule</p>

                                    <div class="form-row cols-2">
                                        <div class="form-group">
                                            <label class="form-label">
                                                Depreciation (WDV Method)
                                                <span class="hint">Use Depreciation Calculator tool</span>
                                            </label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expDepreciation" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                Bad Debts Written Off
                                                <span class="hint">Actual only, no provisions</span>
                                            </label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expBadDebts" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- TIER 5: Estimates/Provisions (Weakest) -->
                                <div class="expense-category tier-5">
                                    <div class="expense-header">
                                        <span class="evidence-badge tier-5">‚ö†Ô∏è Tier 5: Estimates</span>
                                        <span class="deduction-indicator caution">Review Required</span>
                                    </div>
                                    <p class="expense-desc">Miscellaneous expenses - keep minimal, ensure proper vouchers. Cash payments >‚Çπ10K disallowed (Sec 40A(3))</p>

                                    <div class="form-row cols-2">
                                        <div class="form-group">
                                            <label class="form-label">
                                                Other Miscellaneous Expenses
                                                <span class="limit">‚ö†Ô∏è Cash >‚Çπ10K disallowed</span>
                                            </label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expMiscellaneous" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                Entertainment (Partial Deduction)
                                                <span class="hint">Often scrutinized</span>
                                            </label>
                                            <div class="input-currency">
                                                <input type="number" class="form-input" id="expEntertainment" placeholder="0" value="0" oninput="updateBusinessSummary()">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Expense Summary -->
                                <div class="expense-summary-box" style="margin-top: var(--space-6); background: var(--color-neutral-200); border-radius: var(--radius-md); padding: var(--space-4);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-2);">
                                        <div>
                                            <span style="color: var(--color-neutral-500); font-size: var(--font-size-sm);">Total Expenses</span>
                                            <div id="totalExpenses" style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-primary-900);">‚Çπ0</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <span style="color: var(--color-neutral-500); font-size: var(--font-size-sm);">Net Business Income</span>
                                            <div id="netBusinessIncome" style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-accent-green);">‚Çπ0</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Depreciation Calculator Tool -->
                                <div class="depreciation-tool" style="margin-top: var(--space-6); background: linear-gradient(135deg, rgba(255, 152, 0, 0.08) 0%, rgba(255, 152, 0, 0.02) 100%); border: 1px solid var(--tier-3); border-radius: var(--radius-lg); padding: var(--space-5);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-4);">
                                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                                            <span style="font-size: 1.5rem;">üèóÔ∏è</span>
                                            <h4 style="color: var(--color-primary-900); margin: 0;">Depreciation Calculator (WDV Method)</h4>
                                        </div>
                                        <button class="btn btn-secondary" style="padding: var(--space-2) var(--space-3); font-size: var(--font-size-sm);" onclick="addAsset()">+ Add Asset</button>
                                    </div>
                                    <p style="font-size: var(--font-size-sm); color: var(--color-neutral-500); margin-bottom: var(--space-4);">
                                        Add your business assets to calculate depreciation under Written Down Value (WDV) method as per Income Tax Act.
                                    </p>

                                    <div id="asset-register">
                                        <!-- Assets will be added here dynamically -->
                                    </div>

                                    <div id="no-assets-msg" style="text-align: center; padding: var(--space-6); color: var(--color-neutral-400);">
                                        <div style="font-size: 2rem; margin-bottom: var(--space-2);">üìã</div>
                                        <p>No assets added yet. Click "Add Asset" to start building your asset register.</p>
                                    </div>

                                    <!-- Depreciation Summary -->
                                    <div id="depreciation-summary" class="hidden" style="margin-top: var(--space-4); background: var(--color-neutral-100); border-radius: var(--radius-md); padding: var(--space-4);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-2);">
                                            <div>
                                                <span style="color: var(--color-neutral-500); font-size: var(--font-size-sm);">Total Depreciation</span>
                                                <div id="totalDepreciation" style="font-size: var(--font-size-xl); font-weight: 700; color: var(--tier-4);">‚Çπ0</div>
                                            </div>
                                            <button class="btn btn-primary" style="font-size: var(--font-size-sm);" onclick="applyDepreciation()">Apply to Expenses ‚Üë</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-success" id="business-summary" style="margin-top: var(--space-4);">
                                <strong>Business Income:</strong> Deemed Profit: ‚Çπ0
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCapitalGainsSection() {
            return `
                <div class="section-accordion">
                    <div class="section-header open" onclick="toggleSectionAccordion(this)">
                        <h3>üìà Capital Gains</h3>
                        <div class="section-toggle">‚ñº</div>
                    </div>
                    <div class="section-body open">
                        <div class="section-body-inner">
                            <div class="alert alert-warning">
                                <strong>Budget 2024 Rates:</strong> STCG 111A: 20% | LTCG 112A: 12.5% (‚Çπ1.25L exempt) | Other LTCG: 12.5%
                                <br><span style="font-size: var(--font-size-xs);">Note: For assets acquired before 23 July 2024, you can opt for 20% with indexation OR 12.5% without indexation - whichever is beneficial.</span>
                            </div>

                            <h4 style="margin: var(--space-4) 0 var(--space-3); color: var(--color-primary-900);">Short-Term Capital Gains</h4>
                            <div class="form-row cols-2">
                                <div class="form-group">
                                    <label class="form-label">
                                        STCG on Equity (Sec 111A)
                                        <span class="hint">@20% (listed securities with STT)</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="stcg111A" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        Other STCG
                                        <span class="hint">Added to income, taxed at slab rate</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="stcgOther" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>

                            <h4 style="margin: var(--space-6) 0 var(--space-3); color: var(--color-primary-900);">Long-Term Capital Gains</h4>
                            <div class="form-row cols-2">
                                <div class="form-group">
                                    <label class="form-label">
                                        LTCG on Equity (Sec 112A)
                                        <span class="hint">@12.5% above ‚Çπ1.25L exemption</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ltcg112A" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        Other LTCG (Sec 112)
                                        <span class="hint">@12.5% (property, gold, etc.)</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ltcgOther" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>

                            <!-- LTCG Indexation Comparison Tool -->
                            <div class="indexation-tool" style="margin-top: var(--space-6); background: linear-gradient(135deg, rgba(74, 144, 217, 0.08) 0%, rgba(74, 144, 217, 0.02) 100%); border: 1px solid var(--color-primary-300); border-radius: var(--radius-lg); padding: var(--space-5);">
                                <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-4);">
                                    <span style="font-size: 1.5rem;">üßÆ</span>
                                    <h4 style="color: var(--color-primary-900); margin: 0;">LTCG Indexation Comparison Tool</h4>
                                </div>
                                <p style="font-size: var(--font-size-sm); color: var(--color-neutral-500); margin-bottom: var(--space-4);">
                                    For property/gold/debt funds acquired before 23 July 2024, compare: <strong>20% with indexation</strong> vs <strong>12.5% without indexation</strong>
                                </p>

                                <div class="form-row cols-3">
                                    <div class="form-group">
                                        <label class="form-label">Purchase Price</label>
                                        <div class="input-currency">
                                            <input type="number" class="form-input" id="indexPurchasePrice" placeholder="0" value="0" oninput="calculateIndexation()">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Sale Price</label>
                                        <div class="input-currency">
                                            <input type="number" class="form-input" id="indexSalePrice" placeholder="0" value="0" oninput="calculateIndexation()">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Improvement Costs (Optional)</label>
                                        <div class="input-currency">
                                            <input type="number" class="form-input" id="indexImprovement" placeholder="0" value="0" oninput="calculateIndexation()">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row cols-2">
                                    <div class="form-group">
                                        <label class="form-label">Year of Purchase</label>
                                        <select class="form-select" id="indexPurchaseYear" onchange="calculateIndexation()">
                                            <option value="">Select Year</option>
                                            <option value="2001-02">FY 2001-02 (CII: 100)</option>
                                            <option value="2002-03">FY 2002-03 (CII: 105)</option>
                                            <option value="2003-04">FY 2003-04 (CII: 109)</option>
                                            <option value="2004-05">FY 2004-05 (CII: 113)</option>
                                            <option value="2005-06">FY 2005-06 (CII: 117)</option>
                                            <option value="2006-07">FY 2006-07 (CII: 122)</option>
                                            <option value="2007-08">FY 2007-08 (CII: 129)</option>
                                            <option value="2008-09">FY 2008-09 (CII: 137)</option>
                                            <option value="2009-10">FY 2009-10 (CII: 148)</option>
                                            <option value="2010-11">FY 2010-11 (CII: 167)</option>
                                            <option value="2011-12">FY 2011-12 (CII: 184)</option>
                                            <option value="2012-13">FY 2012-13 (CII: 200)</option>
                                            <option value="2013-14">FY 2013-14 (CII: 220)</option>
                                            <option value="2014-15">FY 2014-15 (CII: 240)</option>
                                            <option value="2015-16">FY 2015-16 (CII: 254)</option>
                                            <option value="2016-17">FY 2016-17 (CII: 264)</option>
                                            <option value="2017-18">FY 2017-18 (CII: 272)</option>
                                            <option value="2018-19">FY 2018-19 (CII: 280)</option>
                                            <option value="2019-20">FY 2019-20 (CII: 289)</option>
                                            <option value="2020-21">FY 2020-21 (CII: 301)</option>
                                            <option value="2021-22">FY 2021-22 (CII: 317)</option>
                                            <option value="2022-23">FY 2022-23 (CII: 331)</option>
                                            <option value="2023-24">FY 2023-24 (CII: 348)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Year of Sale</label>
                                        <select class="form-select" id="indexSaleYear" onchange="calculateIndexation()">
                                            <option value="2024-25" selected>FY 2024-25 (CII: 363)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Indexation Results -->
                                <div id="indexation-results" class="hidden" style="margin-top: var(--space-4);">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                                        <div style="background: rgba(33, 150, 243, 0.1); border: 1px solid var(--color-old-regime); border-radius: var(--radius-md); padding: var(--space-4);">
                                            <h5 style="color: var(--color-old-regime); margin-bottom: var(--space-2);">With Indexation (20%)</h5>
                                            <div style="font-size: var(--font-size-sm); color: var(--color-neutral-500);">
                                                <div>Indexed Cost: <span id="indexedCost">‚Çπ0</span></div>
                                                <div>Indexed Gain: <span id="indexedGain">‚Çπ0</span></div>
                                                <div style="font-weight: 700; color: var(--color-old-regime); margin-top: var(--space-2);">Tax: <span id="indexedTax">‚Çπ0</span></div>
                                            </div>
                                        </div>
                                        <div style="background: rgba(76, 175, 80, 0.1); border: 1px solid var(--color-new-regime); border-radius: var(--radius-md); padding: var(--space-4);">
                                            <h5 style="color: var(--color-new-regime); margin-bottom: var(--space-2);">Without Indexation (12.5%)</h5>
                                            <div style="font-size: var(--font-size-sm); color: var(--color-neutral-500);">
                                                <div>Actual Cost: <span id="actualCost">‚Çπ0</span></div>
                                                <div>Actual Gain: <span id="actualGain">‚Çπ0</span></div>
                                                <div style="font-weight: 700; color: var(--color-new-regime); margin-top: var(--space-2);">Tax: <span id="actualTax">‚Çπ0</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="indexation-recommendation" style="margin-top: var(--space-4); padding: var(--space-3); border-radius: var(--radius-md); font-weight: 600; text-align: center;"></div>
                                </div>
                            </div>

                            <!-- Exemption Sections -->
                            <div style="margin-top: var(--space-6);">
                                <h4 style="color: var(--color-primary-900); margin-bottom: var(--space-3);">Capital Gains Exemptions (Optional)</h4>
                                <div class="form-row cols-3">
                                    <div class="form-group">
                                        <label class="form-label">
                                            Sec 54 (Residential House)
                                            <span class="hint">Reinvest in new house</span>
                                        </label>
                                        <div class="input-currency">
                                            <input type="number" class="form-input" id="exemption54" placeholder="0" value="0">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            Sec 54EC (Bonds)
                                            <span class="hint">Invest in NHAI/REC bonds</span>
                                            <span class="limit">Max ‚Çπ50L</span>
                                        </label>
                                        <div class="input-currency">
                                            <input type="number" class="form-input" id="exemption54EC" placeholder="0" value="0" max="5000000">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            Sec 54F (Any Asset)
                                            <span class="hint">Reinvest in residential house</span>
                                        </label>
                                        <div class="input-currency">
                                            <input type="number" class="form-input" id="exemption54F" placeholder="0" value="0">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-success" id="capital-summary" style="margin-top: var(--space-4);">
                                <strong>Capital Gains Tax:</strong> ‚Çπ0
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderOtherSourcesSection() {
            return `
                <div class="section-accordion">
                    <div class="section-header" onclick="toggleSectionAccordion(this)">
                        <h3>üí∞ Other Sources</h3>
                        <div class="section-toggle">‚ñº</div>
                    </div>
                    <div class="section-body">
                        <div class="section-body-inner">
                            <div class="form-row cols-2">
                                <div class="form-group">
                                    <label class="form-label">Interest from Savings Bank</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="interestSavings" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Interest from FD/RD</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="interestFD" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="form-row cols-2">
                                <div class="form-group">
                                    <label class="form-label">Dividend Income</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="dividendIncome" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Other Income</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="otherIncome" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-success" id="other-summary">
                                <strong>Other Sources:</strong> Total: ‚Çπ0
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleSectionAccordion(header) {
            header.classList.toggle('open');
            const body = header.nextElementSibling;
            body.classList.toggle('open');
        }

        function toggleBusinessType() {
            const businessType = document.getElementById('businessType')?.value || 'presumptive44AD';
            TaxState.business.type = businessType;

            // Hide all business type sections
            document.querySelectorAll('.business-type-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Show relevant section
            switch (businessType) {
                case 'presumptive44AD':
                    document.getElementById('section-44ad')?.classList.remove('hidden');
                    break;
                case 'presumptive44ADA':
                    document.getElementById('section-44ada')?.classList.remove('hidden');
                    break;
                case 'presumptive44AE':
                    document.getElementById('section-44ae')?.classList.remove('hidden');
                    break;
                case 'regular':
                    document.getElementById('section-regular')?.classList.remove('hidden');
                    break;
            }

            updateBusinessSummary();
            saveState();
        }

        function updateBusinessSummary() {
            const businessType = document.getElementById('businessType')?.value || 'presumptive44AD';
            const summaryEl = document.getElementById('business-summary');
            let profit = 0;
            let summaryText = '';

            switch (businessType) {
                case 'presumptive44AD': {
                    const turnover = getVal('turnover44AD');
                    const digital = getVal('digital44AD');
                    const cash = turnover - digital;
                    profit = (digital * 0.06) + (Math.max(0, cash) * 0.08);
                    summaryText = `<strong>44AD Presumptive Income:</strong> Digital @ 6%: ${formatCurrency(digital * 0.06)} + Cash @ 8%: ${formatCurrency(Math.max(0, cash) * 0.08)} = <strong>Deemed Profit: ${formatCurrency(profit)}</strong>`;
                    break;
                }
                case 'presumptive44ADA': {
                    const receipts = getVal('receipts44ADA');
                    profit = receipts * 0.50;
                    summaryText = `<strong>44ADA Presumptive Income:</strong> Receipts @ 50% = <strong>Deemed Profit: ${formatCurrency(profit)}</strong>`;
                    break;
                }
                case 'presumptive44AE': {
                    const heavyTons = getVal('heavyVehicleTons');
                    const lightCount = getVal('lightVehicleCount');
                    const months = Math.min(12, Math.max(1, getVal('vehicleMonths') || 12));
                    const heavyProfit = heavyTons * 1000 * months;
                    const lightProfit = lightCount * 7500 * months;
                    profit = heavyProfit + lightProfit;
                    summaryText = `<strong>44AE Transport Income:</strong> Heavy: ${formatCurrency(heavyProfit)} + Light: ${formatCurrency(lightProfit)} = <strong>Deemed Profit: ${formatCurrency(profit)}</strong>`;
                    break;
                }
                case 'regular': {
                    const grossIncome = getVal('grossBusinessIncome');

                    // Tier 1 expenses
                    const expSalaries = getVal('expSalaries');
                    const expRent = getVal('expRent');
                    const expProfessional = getVal('expProfessional');
                    const expInterest = getVal('expInterest');

                    // Tier 2 expenses
                    const expUtilities = getVal('expUtilities');
                    const expTelephone = getVal('expTelephone');
                    const expMaterials = getVal('expMaterials');
                    const expMarketing = getVal('expMarketing');
                    const expSoftware = getVal('expSoftware');

                    // Tier 3 expenses
                    const expTravel = getVal('expTravel');
                    const expRepairs = getVal('expRepairs');
                    const expInsurance = getVal('expInsurance');
                    const expStationery = getVal('expStationery');
                    const expWelfare = getVal('expWelfare');

                    // Tier 4 expenses
                    const expDepreciation = getVal('expDepreciation');
                    const expBadDebts = getVal('expBadDebts');

                    // Tier 5 expenses
                    const expMiscellaneous = getVal('expMiscellaneous');
                    const expEntertainment = getVal('expEntertainment');

                    const totalExpenses = expSalaries + expRent + expProfessional + expInterest +
                        expUtilities + expTelephone + expMaterials + expMarketing + expSoftware +
                        expTravel + expRepairs + expInsurance + expStationery + expWelfare +
                        expDepreciation + expBadDebts + expMiscellaneous + expEntertainment;

                    profit = grossIncome - totalExpenses;

                    // Update inline summaries
                    const totalExpEl = document.getElementById('totalExpenses');
                    const netIncEl = document.getElementById('netBusinessIncome');
                    if (totalExpEl) totalExpEl.textContent = formatCurrency(totalExpenses);
                    if (netIncEl) {
                        netIncEl.textContent = formatCurrency(profit);
                        netIncEl.style.color = profit >= 0 ? 'var(--color-accent-green)' : 'var(--color-accent-red)';
                    }

                    summaryText = `<strong>Regular Business Income:</strong> Gross: ${formatCurrency(grossIncome)} - Expenses: ${formatCurrency(totalExpenses)} = <strong>Net Profit: ${formatCurrency(profit)}</strong>`;
                    break;
                }
            }

            if (summaryEl) {
                summaryEl.innerHTML = summaryText;
            }

            // Store for tax calculation
            TaxState.business.profit = profit;
            TaxState.business.type = businessType;

            saveState();
        }

        function updateCapitalGainsSummary() {
            const summaryEl = document.getElementById('capital-summary');
            if (!summaryEl) return;

            const stcg111A = getVal('stcg111A');
            const ltcg112A = getVal('ltcg112A');
            const ltcgOther = getVal('ltcgOther');
            const stcgOther = getVal('stcgOther');

            // Exemptions
            const ex54 = Math.min(getVal('exemption54'), ltcgOther);
            const ex54EC = Math.min(getVal('exemption54EC'), 5000000, ltcgOther - ex54);
            const ex54F = Math.min(getVal('exemption54F'), ltcgOther - ex54 - ex54EC);
            const totalExemptions = ex54 + ex54EC + ex54F;

            // Budget 2024 rates
            const stcg111ATax = stcg111A * 0.20;
            const ltcg112AExempt = 125000;
            const ltcg112ATaxable = Math.max(0, ltcg112A - ltcg112AExempt);
            const ltcg112ATax = ltcg112ATaxable * 0.125;
            const ltcgTaxable = Math.max(0, ltcgOther - totalExemptions);
            const ltcgOtherTax = ltcgTaxable * 0.125;

            const totalCGTax = stcg111ATax + ltcg112ATax + ltcgOtherTax;

            let exemptionText = totalExemptions > 0 ? ` | Exemptions: ${formatCurrency(totalExemptions)}` : '';
            summaryEl.innerHTML = `<strong>Capital Gains Tax:</strong> STCG 111A @ 20%: ${formatCurrency(stcg111ATax)} | LTCG 112A @ 12.5%: ${formatCurrency(ltcg112ATax)} | Other LTCG @ 12.5%: ${formatCurrency(ltcgOtherTax)}${exemptionText} = <strong>Total CG Tax: ${formatCurrency(totalCGTax)}</strong>`;
        }

        function calculateIndexation() {
            const purchasePrice = getVal('indexPurchasePrice');
            const salePrice = getVal('indexSalePrice');
            const improvement = getVal('indexImprovement');
            const purchaseYear = document.getElementById('indexPurchaseYear')?.value;
            const saleYear = document.getElementById('indexSaleYear')?.value || '2024-25';

            const resultsEl = document.getElementById('indexation-results');
            const recommendEl = document.getElementById('indexation-recommendation');

            if (!purchasePrice || !salePrice || !purchaseYear) {
                resultsEl?.classList.add('hidden');
                return;
            }

            const purchaseCII = TaxConfig.CII_TABLE[purchaseYear] || 100;
            const saleCII = TaxConfig.CII_TABLE[saleYear] || 363;

            // Calculate indexed cost
            const indexedCost = Math.round((purchasePrice * saleCII) / purchaseCII);
            const indexedImprovement = improvement > 0 ? Math.round((improvement * saleCII) / purchaseCII) : 0;
            const totalIndexedCost = indexedCost + indexedImprovement;

            // With indexation (20%)
            const indexedGain = Math.max(0, salePrice - totalIndexedCost);
            const indexedTax = indexedGain * 0.20;

            // Without indexation (12.5%)
            const actualCost = purchasePrice + improvement;
            const actualGain = Math.max(0, salePrice - actualCost);
            const actualTax = actualGain * 0.125;

            // Update display
            document.getElementById('indexedCost').textContent = formatCurrency(totalIndexedCost);
            document.getElementById('indexedGain').textContent = formatCurrency(indexedGain);
            document.getElementById('indexedTax').textContent = formatCurrency(indexedTax);
            document.getElementById('actualCost').textContent = formatCurrency(actualCost);
            document.getElementById('actualGain').textContent = formatCurrency(actualGain);
            document.getElementById('actualTax').textContent = formatCurrency(actualTax);

            // Recommendation
            const savings = Math.abs(indexedTax - actualTax);
            if (indexedTax < actualTax) {
                recommendEl.innerHTML = `‚úÖ <strong>With Indexation is better!</strong> You save ${formatCurrency(savings)}`;
                recommendEl.style.background = 'rgba(33, 150, 243, 0.15)';
                recommendEl.style.color = 'var(--color-old-regime)';
            } else if (actualTax < indexedTax) {
                recommendEl.innerHTML = `‚úÖ <strong>Without Indexation is better!</strong> You save ${formatCurrency(savings)}`;
                recommendEl.style.background = 'rgba(76, 175, 80, 0.15)';
                recommendEl.style.color = 'var(--color-new-regime)';
            } else {
                recommendEl.innerHTML = `‚öñÔ∏è <strong>Both options result in same tax.</strong>`;
                recommendEl.style.background = 'var(--color-neutral-200)';
                recommendEl.style.color = 'var(--color-neutral-600)';
            }

            resultsEl?.classList.remove('hidden');
        }

        // ============================================
        // DEPRECIATION CALCULATOR
        // ============================================
        let assetCounter = 0;

        function addAsset() {
            assetCounter++;
            const assetRegister = document.getElementById('asset-register');
            const noAssetsMsg = document.getElementById('no-assets-msg');

            if (noAssetsMsg) noAssetsMsg.classList.add('hidden');

            const assetHtml = `
                <div class="asset-row" id="asset-${assetCounter}" style="background: var(--color-neutral-100); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-3); border: 1px solid var(--color-neutral-300);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);">
                        <span style="font-weight: 600; color: var(--color-primary-900);">Asset #${assetCounter}</span>
                        <button class="btn" style="background: var(--color-accent-red); color: #fff; padding: var(--space-1) var(--space-2); font-size: var(--font-size-xs);" onclick="removeAsset(${assetCounter})">‚úï Remove</button>
                    </div>
                    <div class="form-row cols-3" style="margin-bottom: 0;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Asset Type</label>
                            <select class="form-select" id="assetType-${assetCounter}" onchange="calculateAllDepreciation()">
                                <option value="building5">Building (Residential) - 5%</option>
                                <option value="building10">Building (Others) - 10%</option>
                                <option value="furniture">Furniture & Fittings - 10%</option>
                                <option value="plant15" selected>Plant & Machinery - 15%</option>
                                <option value="vehicle15">Motor Vehicles - 15%</option>
                                <option value="vehicle30">Commercial Vehicles - 30%</option>
                                <option value="computer">Computers & Software - 40%</option>
                                <option value="intangible">Intangible Assets - 25%</option>
                                <option value="energy">Energy Saving Devices - 40%</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Opening WDV / Cost</label>
                            <div class="input-currency">
                                <input type="number" class="form-input" id="assetWDV-${assetCounter}" placeholder="0" value="0" oninput="calculateAllDepreciation()">
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">
                                Months Used
                                <span class="hint">Full year = 12, Half = 6</span>
                            </label>
                            <input type="number" class="form-input" id="assetMonths-${assetCounter}" placeholder="12" value="12" min="1" max="12" oninput="calculateAllDepreciation()">
                        </div>
                    </div>
                    <div style="margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px dashed var(--color-neutral-300); display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: var(--font-size-sm); color: var(--color-neutral-500);">Depreciation:</span>
                        <span id="assetDep-${assetCounter}" style="font-weight: 700; color: var(--tier-4);">‚Çπ0</span>
                    </div>
                </div>
            `;

            assetRegister.insertAdjacentHTML('beforeend', assetHtml);
            calculateAllDepreciation();
        }

        function removeAsset(id) {
            const assetEl = document.getElementById(`asset-${id}`);
            if (assetEl) {
                assetEl.remove();
            }

            // Check if any assets remain
            const assetRegister = document.getElementById('asset-register');
            if (assetRegister && assetRegister.children.length === 0) {
                document.getElementById('no-assets-msg')?.classList.remove('hidden');
                document.getElementById('depreciation-summary')?.classList.add('hidden');
            }

            calculateAllDepreciation();
        }

        function calculateAllDepreciation() {
            const assetRegister = document.getElementById('asset-register');
            if (!assetRegister) return;

            let totalDep = 0;
            const assetRows = assetRegister.querySelectorAll('.asset-row');

            assetRows.forEach(row => {
                const id = row.id.replace('asset-', '');
                const assetType = document.getElementById(`assetType-${id}`)?.value || 'plant15';
                const wdv = getVal(`assetWDV-${id}`);
                const months = Math.min(12, Math.max(1, getVal(`assetMonths-${id}`) || 12));

                const rate = TaxConfig.DEP_RATES[assetType]?.rate || 0.15;

                // WDV depreciation: Rate * WDV * (Months/12)
                // For assets used < 180 days, half rate applies (simplified: if months <= 6)
                const effectiveRate = months <= 6 ? rate / 2 : rate;
                const depreciation = Math.round(wdv * effectiveRate);

                const depEl = document.getElementById(`assetDep-${id}`);
                if (depEl) depEl.textContent = formatCurrency(depreciation);

                totalDep += depreciation;
            });

            // Update summary
            const summaryEl = document.getElementById('depreciation-summary');
            const totalEl = document.getElementById('totalDepreciation');

            if (assetRows.length > 0) {
                summaryEl?.classList.remove('hidden');
                if (totalEl) totalEl.textContent = formatCurrency(totalDep);
            } else {
                summaryEl?.classList.add('hidden');
            }

            // Store in state
            TaxState.assets = [];
            assetRows.forEach(row => {
                const id = row.id.replace('asset-', '');
                TaxState.assets.push({
                    type: document.getElementById(`assetType-${id}`)?.value,
                    wdv: getVal(`assetWDV-${id}`),
                    months: getVal(`assetMonths-${id}`)
                });
            });
            TaxState.totalDepreciation = totalDep;
            saveState();
        }

        function applyDepreciation() {
            const totalDep = TaxState.totalDepreciation || 0;
            const depInput = document.getElementById('expDepreciation');
            if (depInput) {
                depInput.value = totalDep;
                updateBusinessSummary();
            }
        }

        function attachInputListeners() {
            // Attach change listeners to all inputs for auto-calculation
            document.querySelectorAll('.form-input').forEach(input => {
                input.addEventListener('change', updateSummaries);
                input.addEventListener('input', updateSummaries);
            });
        }

        function updateSummaries() {
            // Update salary summary
            const salaryEl = document.getElementById('salary-summary');
            if (salaryEl) {
                const basic = getVal('basicSalary');
                const da = getVal('da');
                const hra = getVal('hra');
                const actualRent = getVal('actualRent');
                const cityType = document.getElementById('cityType')?.value || 'metro';
                const lta = getVal('lta');
                const special = getVal('specialAllowance');
                const bonus = getVal('salaryBonus');
                const perks = getVal('perquisites');

                const basicPlusDa = basic + da;
                const cityPercent = cityType === 'metro' ? 0.50 : 0.40;
                const hraExempt1 = hra;
                const hraExempt2 = basicPlusDa * cityPercent;
                const hraExempt3 = Math.max(0, actualRent - (basicPlusDa * 0.10));
                const hraExemption = Math.min(hraExempt1, hraExempt2, hraExempt3);

                const gross = basic + da + hra + lta + special + bonus + perks;
                const net = gross - hraExemption;

                salaryEl.innerHTML = `<strong>Salary Summary:</strong> Gross: ${formatCurrency(gross)} | HRA Exemption: ${formatCurrency(hraExemption)} | <strong>Net Taxable: ${formatCurrency(net)}</strong>`;
            }

            // Update business summary (delegate to specialized function)
            if (document.getElementById('business-summary')) {
                updateBusinessSummary();
            }

            // Update capital gains summary
            updateCapitalGainsSummary();
        }

        // ============================================
        // STEP 4: DEDUCTIONS
        // ============================================
        function renderDeductionsSections() {
            const container = document.getElementById('deductions-container');
            const warning = document.getElementById('deductions-new-regime-warning');

            // Always show deductions - they're used for old regime comparison
            warning.classList.add('hidden');

            container.innerHTML = `
                <div class="section-accordion">
                    <div class="section-header open" onclick="toggleSectionAccordion(this)">
                        <h3>Section 80C - Investments <span class="badge" style="background: var(--color-accent-green); color: #fff;">Limit: ‚Çπ1.5L</span></h3>
                        <div class="section-toggle">‚ñº</div>
                    </div>
                    <div class="section-body open">
                        <div class="section-body-inner">
                            <div class="form-row cols-3">
                                <div class="form-group">
                                    <label class="form-label">PPF / VPF</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80C_ppf" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ELSS Mutual Funds</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80C_elss" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Life Insurance Premium</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80C_lic" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="form-row cols-3">
                                <div class="form-group">
                                    <label class="form-label">NSC / SCSS</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80C_nsc" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Home Loan Principal</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80C_hlp" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tuition Fees (2 children)</label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80C_tuition" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-accordion">
                    <div class="section-header" onclick="toggleSectionAccordion(this)">
                        <h3>Section 80D - Health Insurance</h3>
                        <div class="section-toggle">‚ñº</div>
                    </div>
                    <div class="section-body">
                        <div class="section-body-inner">
                            <div class="form-row cols-2">
                                <div class="form-group">
                                    <label class="form-label">
                                        Self & Family Premium
                                        <span class="limit">Max ‚Çπ25K (‚Çπ50K if senior)</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80D_self" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        Parents Premium
                                        <span class="limit">Max ‚Çπ50K</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80D_parents" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-accordion">
                    <div class="section-header" onclick="toggleSectionAccordion(this)">
                        <h3>NPS & Education</h3>
                        <div class="section-toggle">‚ñº</div>
                    </div>
                    <div class="section-body">
                        <div class="section-body-inner">
                            <div class="form-row cols-2">
                                <div class="form-group">
                                    <label class="form-label">
                                        80CCD(1B) - NPS Additional
                                        <span class="limit">Max ‚Çπ50K</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80CCD1B" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        80E - Education Loan Interest
                                        <span class="hint">No upper limit, 8 years max</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80E" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-accordion">
                    <div class="section-header" onclick="toggleSectionAccordion(this)">
                        <h3>Disability & Medical (80DD, 80DDB, 80U)</h3>
                        <div class="section-toggle">‚ñº</div>
                    </div>
                    <div class="section-body">
                        <div class="section-body-inner">
                            <div class="form-row cols-3">
                                <div class="form-group">
                                    <label class="form-label">
                                        80DD - Disabled Dependent
                                        <span class="limit">‚Çπ75K / ‚Çπ1.25L (severe)</span>
                                    </label>
                                    <select class="form-select" id="ded80DD">
                                        <option value="0">Not Applicable</option>
                                        <option value="75000">Disability (40-80%) - ‚Çπ75,000</option>
                                        <option value="125000">Severe (80%+) - ‚Çπ1,25,000</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        80DDB - Medical Treatment
                                        <span class="limit">Max ‚Çπ40K (‚Çπ1L for senior)</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80DDB" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        80U - Self Disability
                                        <span class="limit">‚Çπ75K / ‚Çπ1.25L (severe)</span>
                                    </label>
                                    <select class="form-select" id="ded80U">
                                        <option value="0">Not Applicable</option>
                                        <option value="75000">Disability (40-80%) - ‚Çπ75,000</option>
                                        <option value="125000">Severe (80%+) - ‚Çπ1,25,000</option>
                                    </select>
                                </div>
                            </div>
                            <div class="alert alert-info" style="margin-top: var(--space-3);">
                                <strong>Note:</strong> 80DD requires Form 10-IA certificate. 80DDB requires prescription from specialist doctor. 80U requires certificate from medical authority.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-accordion">
                    <div class="section-header" onclick="toggleSectionAccordion(this)">
                        <h3>Housing & Interest (80EE, 80EEA, 80GG)</h3>
                        <div class="section-toggle">‚ñº</div>
                    </div>
                    <div class="section-body">
                        <div class="section-body-inner">
                            <div class="form-row cols-3">
                                <div class="form-group">
                                    <label class="form-label">
                                        80EE - First Home Loan Interest
                                        <span class="limit">Max ‚Çπ50K (Loan sanctioned 2016-17)</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80EE" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        80EEA - Affordable Housing
                                        <span class="limit">Max ‚Çπ1.5L (Stamp ‚â§‚Çπ45L)</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80EEA" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        80GG - Rent Paid (No HRA)
                                        <span class="limit">Max ‚Çπ5K/month</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80GG" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info" style="margin-top: var(--space-3);">
                                <strong>80GG:</strong> For individuals who don't receive HRA. Deduction = least of: Rent paid - 10% of income, 25% of total income, or ‚Çπ5,000/month (‚Çπ60K/year).
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-accordion">
                    <div class="section-header" onclick="toggleSectionAccordion(this)">
                        <h3>Savings & Donations (80TTA, 80TTB, 80G)</h3>
                        <div class="section-toggle">‚ñº</div>
                    </div>
                    <div class="section-body">
                        <div class="section-body-inner">
                            <div class="form-row cols-3">
                                <div class="form-group">
                                    <label class="form-label">
                                        80TTA - Savings Interest
                                        <span class="limit">Max ‚Çπ10K (Non-seniors)</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80TTA" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        80TTB - Senior Interest
                                        <span class="limit">Max ‚Çπ50K (60+ years)</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80TTB" placeholder="0" value="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        80G - Donations
                                        <span class="hint">100% or 50% eligible</span>
                                    </label>
                                    <div class="input-currency">
                                        <input type="number" class="form-input" id="ded80G" placeholder="0" value="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // TAX CALCULATIONS
        // ============================================
        function calculateNewRegimeTax(income) {
            let tax = 0;
            if (income <= 300000) tax = 0;
            else if (income <= 700000) tax = (income - 300000) * 0.05;
            else if (income <= 1000000) tax = 20000 + (income - 700000) * 0.10;
            else if (income <= 1200000) tax = 50000 + (income - 1000000) * 0.15;
            else if (income <= 1500000) tax = 80000 + (income - 1200000) * 0.20;
            else tax = 140000 + (income - 1500000) * 0.30;

            // Rebate u/s 87A for income up to 7L
            if (income <= 700000) tax = 0;
            return tax;
        }

        function calculateOldRegimeTax(income, ageGroup) {
            let exemption = 250000;
            if (ageGroup === 'senior') exemption = 300000;
            else if (ageGroup === 'supersenior') exemption = 500000;

            let tax = 0;
            if (income <= exemption) tax = 0;
            else if (income <= 500000) tax = (income - exemption) * 0.05;
            else if (income <= 1000000) tax = (500000 - exemption) * 0.05 + (income - 500000) * 0.20;
            else tax = (500000 - exemption) * 0.05 + 500000 * 0.20 + (income - 1000000) * 0.30;

            // Rebate u/s 87A for income up to 5L
            if (income <= 500000) tax = Math.max(0, tax - 12500);
            return tax;
        }

        function calculateSurcharge(tax, taxableIncome, isNewRegime, isCapitalGains = false) {
            if (isCapitalGains) {
                if (taxableIncome > 10000000) return tax * 0.15;
                else if (taxableIncome > 5000000) return tax * 0.10;
                return 0;
            }

            if (isNewRegime) {
                if (taxableIncome > 20000000) return tax * 0.25;
                else if (taxableIncome > 10000000) return tax * 0.15;
                else if (taxableIncome > 5000000) return tax * 0.10;
            } else {
                if (taxableIncome > 50000000) return tax * 0.37;
                else if (taxableIncome > 20000000) return tax * 0.25;
                else if (taxableIncome > 10000000) return tax * 0.15;
                else if (taxableIncome > 5000000) return tax * 0.10;
            }
            return 0;
        }

        function calculateAndShowResults() {
            const ageGroup = document.getElementById('ageGroup')?.value || 'general';

            // Calculate Gross Total Income
            let grossIncome = 0;

            // Salary
            if (TaxState.incomeSources.salary) {
                const basic = getVal('basicSalary');
                const da = getVal('da');
                const hra = getVal('hra');
                const lta = getVal('lta');
                const special = getVal('specialAllowance');
                const bonus = getVal('salaryBonus');
                const perks = getVal('perquisites');
                const actualRent = getVal('actualRent');
                const cityType = document.getElementById('cityType')?.value || 'metro';

                const basicPlusDa = basic + da;
                const cityPercent = cityType === 'metro' ? 0.50 : 0.40;
                const hraExemption = Math.min(hra, basicPlusDa * cityPercent, Math.max(0, actualRent - basicPlusDa * 0.10));

                grossIncome += basic + da + hra + lta + special + bonus + perks - hraExemption;
            }

            // House Property
            if (TaxState.incomeSources.house) {
                const type = document.getElementById('propertyType')?.value || 'selfoccupied';
                const rent = getVal('annualRent');
                const municipal = getVal('municipalTax');
                const interest = getVal('homeLoanInterest');

                if (type === 'selfoccupied') {
                    grossIncome -= Math.min(interest, 200000);
                } else {
                    const nav = rent - municipal;
                    const stdDed = nav * 0.30;
                    grossIncome += nav - stdDed - interest;
                }
            }

            // Business
            if (TaxState.incomeSources.business) {
                const turnover = getVal('turnover44AD');
                const digital = getVal('digital44AD');
                const cash = turnover - digital;
                grossIncome += (digital * 0.06) + (cash * 0.08);
            }

            // Capital Gains (taxed separately but added to GTI)
            let capitalGainsTax = 0;
            if (TaxState.incomeSources.capital) {
                const stcg111A = getVal('stcg111A');
                const ltcg112A = Math.max(0, getVal('ltcg112A') - 125000);
                const ltcgOther = getVal('ltcgOther');
                const stcgOther = getVal('stcgOther');

                capitalGainsTax = (stcg111A * 0.20) + (ltcg112A * 0.125) + (ltcgOther * 0.125);
                grossIncome += stcgOther; // Other STCG taxed at slab
            }

            // Other Sources
            if (TaxState.incomeSources.other) {
                grossIncome += getVal('interestSavings') + getVal('interestFD') + getVal('dividendIncome') + getVal('otherIncome');
            }

            // Calculate deductions
            let totalDeductions = 0;

            // 80C - Investments (limit ‚Çπ1.5L)
            totalDeductions += Math.min(150000,
                getVal('ded80C_ppf') + getVal('ded80C_elss') + getVal('ded80C_lic') +
                getVal('ded80C_nsc') + getVal('ded80C_hlp') + getVal('ded80C_tuition')
            );

            // 80CCD(1B) - NPS (limit ‚Çπ50K)
            totalDeductions += Math.min(50000, getVal('ded80CCD1B'));

            // 80D - Health Insurance
            const isSenior = ageGroup === 'senior' || ageGroup === 'supersenior';
            const d80DSelfLimit = isSenior ? 50000 : 25000;
            totalDeductions += Math.min(d80DSelfLimit, getVal('ded80D_self'));
            totalDeductions += Math.min(50000, getVal('ded80D_parents'));

            // 80DD - Disabled Dependent (fixed amounts)
            totalDeductions += parseFloat(document.getElementById('ded80DD')?.value || 0);

            // 80DDB - Medical Treatment (limit based on age)
            const d80DDBLimit = isSenior ? 100000 : 40000;
            totalDeductions += Math.min(d80DDBLimit, getVal('ded80DDB'));

            // 80E - Education Loan Interest (no limit)
            totalDeductions += getVal('ded80E');

            // 80EE - First Home Loan Interest (limit ‚Çπ50K)
            totalDeductions += Math.min(50000, getVal('ded80EE'));

            // 80EEA - Affordable Housing Interest (limit ‚Çπ1.5L)
            totalDeductions += Math.min(150000, getVal('ded80EEA'));

            // 80GG - Rent Paid without HRA (limit ‚Çπ60K per year)
            totalDeductions += Math.min(60000, getVal('ded80GG'));

            // 80TTA - Savings Interest for Non-seniors (limit ‚Çπ10K)
            if (!isSenior) {
                totalDeductions += Math.min(10000, getVal('ded80TTA'));
            }

            // 80TTB - Interest for Seniors (limit ‚Çπ50K)
            if (isSenior) {
                totalDeductions += Math.min(50000, getVal('ded80TTB'));
            }

            // 80U - Self Disability (fixed amounts)
            totalDeductions += parseFloat(document.getElementById('ded80U')?.value || 0);

            // 80G - Donations (no standard limit, depends on donation type)
            totalDeductions += getVal('ded80G');

            // Standard deduction
            const stdDeduction = TaxState.incomeSources.salary ? 50000 : 0;

            // Taxable income
            const taxableNew = Math.max(0, grossIncome - 75000); // New regime standard deduction is 75000
            const taxableOld = Math.max(0, grossIncome - stdDeduction - totalDeductions);

            // Calculate taxes
            const newBasicTax = calculateNewRegimeTax(taxableNew);
            const oldBasicTax = calculateOldRegimeTax(taxableOld, ageGroup);

            const newSurcharge = calculateSurcharge(newBasicTax, taxableNew, true);
            const oldSurcharge = calculateSurcharge(oldBasicTax, taxableOld, false);

            const newTaxBeforeCess = newBasicTax + newSurcharge + capitalGainsTax;
            const oldTaxBeforeCess = oldBasicTax + oldSurcharge + capitalGainsTax;

            const newCess = newTaxBeforeCess * 0.04;
            const oldCess = oldTaxBeforeCess * 0.04;

            const newTotal = newTaxBeforeCess + newCess;
            const oldTotal = oldTaxBeforeCess + oldCess;

            // Update UI
            document.getElementById('summary-gti').textContent = formatCurrency(grossIncome);
            document.getElementById('summary-deductions').textContent = formatCurrency(totalDeductions);
            document.getElementById('summary-taxable-old').textContent = formatCurrency(taxableOld);
            document.getElementById('summary-taxable-new').textContent = formatCurrency(taxableNew);

            document.getElementById('new-basic-tax').textContent = formatCurrency(newBasicTax);
            document.getElementById('new-surcharge').textContent = formatCurrency(newSurcharge);
            document.getElementById('new-marginal').textContent = '‚Çπ0';
            document.getElementById('new-cess').textContent = formatCurrency(newCess);
            document.getElementById('new-tax-total').textContent = formatCurrency(newTotal);

            document.getElementById('old-basic-tax').textContent = formatCurrency(oldBasicTax);
            document.getElementById('old-surcharge').textContent = formatCurrency(oldSurcharge);
            document.getElementById('old-marginal').textContent = '‚Çπ0';
            document.getElementById('old-cess').textContent = formatCurrency(oldCess);
            document.getElementById('old-tax-total').textContent = formatCurrency(oldTotal);

            // Recommendation
            const newCard = document.getElementById('new-regime-result');
            const oldCard = document.getElementById('old-regime-result');
            newCard.classList.remove('recommended');
            oldCard.classList.remove('recommended');

            const savings = Math.abs(newTotal - oldTotal);
            if (newTotal <= oldTotal) {
                newCard.classList.add('recommended');
                document.getElementById('savings-text').textContent = 'by choosing New Tax Regime';
            } else {
                oldCard.classList.add('recommended');
                document.getElementById('savings-text').textContent = 'by choosing Old Tax Regime';
            }
            document.getElementById('savings-amount').textContent = `You Save ${formatCurrency(savings)}`;

            // Store results
            TaxState.results = { newTotal, oldTotal, savings };
            saveState();

            // Update TDS reconciliation
            updateTDSReconciliation();
        }

        function updateTDSReconciliation() {
            const results = TaxState.results;
            if (!results) return;

            // Get recommended tax (lower of the two)
            const taxLiability = Math.min(results.newTotal, results.oldTotal);

            // Sum all TDS and tax paid
            const totalPaid =
                getVal('tds192') + getVal('tds194A') + getVal('tds194') +
                getVal('tds194J') + getVal('tds194I') + getVal('tdsOther') +
                getVal('advanceTax') + getVal('selfAssessment');

            const balance = totalPaid - taxLiability;

            // Update UI
            const liabilityEl = document.getElementById('recTaxLiability');
            const paidEl = document.getElementById('recTotalPaid');
            const balanceEl = document.getElementById('recBalance');
            const messageEl = document.getElementById('recMessage');

            if (liabilityEl) liabilityEl.textContent = formatCurrency(taxLiability);
            if (paidEl) paidEl.textContent = formatCurrency(totalPaid);

            if (balanceEl) {
                balanceEl.textContent = formatCurrency(Math.abs(balance));
                if (balance >= 0) {
                    balanceEl.style.color = 'var(--color-accent-green)';
                } else {
                    balanceEl.style.color = 'var(--color-accent-red)';
                }
            }

            if (messageEl) {
                if (balance > 0) {
                    messageEl.innerHTML = `üéâ <strong>Refund Due:</strong> ${formatCurrency(balance)} will be credited to your bank account after processing.`;
                    messageEl.style.background = 'rgba(76, 175, 80, 0.15)';
                    messageEl.style.color = 'var(--color-accent-green)';
                } else if (balance < 0) {
                    messageEl.innerHTML = `‚ö†Ô∏è <strong>Tax Payable:</strong> ${formatCurrency(Math.abs(balance))} needs to be paid via Challan 280 before filing ITR.`;
                    messageEl.style.background = 'rgba(244, 67, 54, 0.15)';
                    messageEl.style.color = 'var(--color-accent-red)';
                } else {
                    messageEl.innerHTML = `‚úÖ <strong>Nil Balance:</strong> No additional tax payable and no refund due.`;
                    messageEl.style.background = 'var(--color-neutral-200)';
                    messageEl.style.color = 'var(--color-neutral-600)';
                }
            }
        }

        function exportToPDF() {
            // Simple PDF export using print dialog with PDF option
            const printStyles = `
                @media print {
                    body { background: #fff !important; }
                    .wizard-header, .wizard-nav, .btn, .card-title .icon { display: none !important; }
                    .wizard-container { box-shadow: none !important; }
                    .app-header { color: #000 !important; background: none !important; }
                    .app-title { -webkit-text-fill-color: #1a1a2e !important; background: none !important; }
                    .regime-card { break-inside: avoid; }
                }
            `;

            const styleEl = document.createElement('style');
            styleEl.textContent = printStyles;
            document.head.appendChild(styleEl);

            window.print();

            // Clean up after a delay
            setTimeout(() => styleEl.remove(), 1000);
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            loadState();

            // Sync UI with loaded state
            if (TaxState.assesseeType) {
                const card = document.querySelector(`.assessee-card[data-type="${TaxState.assesseeType}"]`);
                if (card) selectAssesseeType(card);
            }

            // Restore income sources
            Object.entries(TaxState.incomeSources).forEach(([source, selected]) => {
                if (selected) {
                    const card = document.querySelector(`.income-source-card[data-source="${source}"]`);
                    if (card) card.classList.add('selected');
                }
            });

            // Go to saved step
            if (TaxState.currentStep > 1) {
                goToStep(TaxState.currentStep);
            }

            // Add keyboard navigation support
            setupKeyboardNavigation();
        });

        function setupKeyboardNavigation() {
            // Wizard step keyboard navigation
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        goToStep(parseInt(step.dataset.step));
                    }
                });
            });

            // Assessee card keyboard navigation
            document.querySelectorAll('.assessee-card').forEach(card => {
                card.setAttribute('tabindex', '0');
                card.setAttribute('role', 'button');
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectAssesseeType(card);
                    }
                });
            });

            // Income source card keyboard navigation
            document.querySelectorAll('.income-source-card').forEach(card => {
                card.setAttribute('tabindex', '0');
                card.setAttribute('role', 'checkbox');
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleIncomeSource(card);
                    }
                });
            });

            // Section accordion keyboard navigation
            document.querySelectorAll('.section-header').forEach(header => {
                header.setAttribute('tabindex', '0');
                header.setAttribute('role', 'button');
                header.setAttribute('aria-expanded', header.classList.contains('open'));
                header.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleSectionAccordion(header);
                        header.setAttribute('aria-expanded', header.classList.contains('open'));
                    }
                });
            });
        }
    </script>
</body>
</html>
